---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
```

Identify which SNVs are disease specific hits (ie, differentially active in the MPRA in the cell type relevant to the cancer they're associated with)
Recode column disease_expanded so it's using the same words for each cancer/tissue type.
```{r}
res_merge <- read_tsv(here("output/res_merge_witheQTLgen_11.1.2020.tsv"))
```
Rename disease expanded to match hits
```{r}
snp_dis <- dplyr::select(res_merge, Causal_SNP, Disease_expanded) %>%
  mutate(Disease_expanded = str_split(Disease_expanded, ",")) %>%
  unnest(Disease_expanded)
snp_dis <- snp_dis %>% mutate(Disease_expanded = case_when(
  Disease_expanded == "lung" ~ "airway",
  Disease_expanded == "brca" ~ "hmec",
  Disease_expanded == "melanoma" ~ "mc",
  Disease_expanded == "ovca" ~ "ov",
  Disease_expanded == "skin" ~ "kc",
  Disease_expanded == "brca_esophagus" ~ "hmec,eso",
  Disease_expanded == "endometrial" ~ "endo",
  Disease_expanded == "paad" ~ "panc",
  Disease_expanded == "kidney" ~ "renal",
  Disease_expanded == "brain" ~ "ast",
  Disease_expanded == "thyroid" ~ "thy",
  Disease_expanded == "prad" ~ "pros",
  Disease_expanded == "lymphoma" ~ "gm",
  Disease_expanded == "esophagus" ~ "eso",
  T ~ ""))
snp_dis <- snp_dis %>% group_by(Causal_SNP) %>% 
  summarise(Disease_expanded = paste(sort(unique(Disease_expanded)), collapse=","))
res_merge <- left_join(dplyr::select(res_merge, -Disease_expanded), snp_dis)
```

Annotate hits for any cell type (SNVs differentially active in that cell type) and hits in the correct cell type
```{r}
hits <- res_merge[, grepl("fdr", colnames(res_merge))]
colnames(hits)
hits$locus <- res_merge$locus
hits$disease <- res_merge$Disease_expanded
hits <- pivot_longer(hits, cols= airway_fdr:thy_fdr, names_to = "cell_type", values_to="fdr")
hits <- hits %>% mutate(cell_type = str_remove(cell_type, "_fdr") )

hits <- hits %>% mutate(hit_any_celltype = ifelse(fdr < 0.05, cell_type,NA))
hits <- hits %>% rowwise() %>%
  mutate(hit_dis_spec = ifelse(grepl(hit_any_celltype, disease), cell_type, NA))
hits <- hits %>% group_by(locus) %>%
  summarise(hit_any_celltype = paste(sort(unique(hit_any_celltype[!is.na(hit_any_celltype)])),
                                     collapse=","),
            hit_spec = paste(sort(unique(hit_dis_spec[!is.na(hit_dis_spec)])), collapse=","))
```

```{r}
res_merge <- left_join(res_merge, hits)
 write_tsv(res_merge, here("output/res_merge_withhitannot_031021.tsv"))
```



